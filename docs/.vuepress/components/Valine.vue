<!-- docs/.vuepress/components/Valine.vue -->
<!-- 关闭评论：在md开头配置 `frontmatter` 中添加 `comment:false` 即可 -->
<template>
  <div class="ValineComment" v-if="comment">
    <!-- <hr>
    <span :id="page.path" class="leancloud-visitors" :data-flag-title="page.title">
      <em class="post-meta-item-text">文章阅读量 </em>
      <i class="leancloud-visitors-count">1000000+</i>
    </span> -->
    <div id="vcomments"></div>
  </div>
</template>

<script>
export default {
  name: 'Valine',
  computed: {
    comment: function() {
      let { comment } = this.$frontmatter;
      if (typeof comment === "undefined") {
        return true;
      }
      return comment;
    },
    page: function() {
      let { path = "/", title = "首页" } = this.$page;
      return { path, title };
    }
  },
  mounted() {
    this.renderValine();
  },
  watch: {
    $route: {
      handler: function(to, from) {
        if (to.path !== from.path) {
          this.$nextTick(() => {
            this.renderValine();
          });
        }
      }
    }
  },
  methods: {
    renderValine() {
      if (typeof window !== "undefined") {
        this.window = window;
        window.AV = require("leancloud-storage");
      }
      const secretKeyConf = require("../../../config/secretKeyConf.js");
      const Valine = require("valine");
      new Valine({
        el: "#vcomments",
        appId: secretKeyConf.appId,
        appKey: secretKeyConf.appKey,
        notify: true,
        verify: true,
        avatar: "retro",
        path: window.location.pathname,
        meta: ["nick", "mail", "link"],
        pageSize: 10,
        visitor: true, //阅读访问量
        placeholder: "欢迎留言..."
      });
    }
  }
};
</script>

<style lang="stylus" scoped>
.ValineComment {
  width: 50%;
  padding: 0 2rem;
  margin: 0 auto;
}

.leancloud-visitors {
  display: inline-block;
  margin-bottom: 1rem;
}
</style>
